<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®ç»´æŠ¤ - å´©åæ˜Ÿç©¹é“é“è§’è‰²ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        body { font-family: 'Microsoft YaHei', Arial, sans-serif; margin: 0; padding: 20px; background: #f5f7fa; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
        .header h1 { margin: 0; font-size: 2.5em; font-weight: 300; }
        .header p { margin: 10px 0 0 0; opacity: 0.9; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        .section { background: white; margin: 25px 0; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-left: 4px solid #667eea; }
        .section h2 { color: #2c3e50; margin: 0 0 25px 0; font-size: 1.8em; font-weight: 500; }
        
        .form-group { margin: 20px 0; }
        .form-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin: 15px 0; }
        .form-col { display: flex; flex-direction: column; gap: 15px; }
        
        input[type="text"], textarea, select { 
            padding: 12px 16px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px; 
            min-width: 200px; transition: all 0.3s ease; background: #fff;
        }
        input[type="text"]:focus, textarea:focus, select:focus { 
            outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); 
        }
        textarea { min-height: 80px; resize: vertical; font-family: inherit; }
        
        button { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; 
            padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;
            margin: 5px; transition: all 0.3s ease; box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4); }
        .btn-success { background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); }
        .btn-danger { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); }
        .btn-warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .btn-info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        
        .status { 
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 15px; border-radius: 8px; 
            margin: 15px 0; font-family: 'Consolas', monospace; font-size: 13px; 
            max-height: 200px; overflow-y: auto; border-left: 4px solid #6c757d;
        }
        .log-success { color: #28a745; font-weight: 500; }
        .log-error { color: #dc3545; font-weight: 500; }
        .log-info { color: #007bff; font-weight: 500; }
        .log-warning { color: #ffc107; font-weight: 500; }
        
        .modal { 
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
        }
        .modal-content { 
            background: white; margin: 10% auto; padding: 30px; width: 500px; border-radius: 12px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: modalSlideIn 0.3s ease;
        }
        @keyframes modalSlideIn { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 25px; }
        
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .form-row { flex-direction: column; align-items: stretch; }
            .modal-content { width: 90%; margin: 5% auto; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" style="position: relative;">
            <a href="planner_home.html" style="position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.2); color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-size: 14px; transition: background 0.3s ease;">â† è¿”å›ç­–åˆ’ä¸»é¡µ</a>
            <h1>ğŸ› ï¸ æ•°æ®ç»´æŠ¤ç³»ç»Ÿ</h1>
            <p>æ¬¢è¿ï¼Œ<span id="username">ç­–åˆ’</span> | <a href="login.html" style="color: #fff; text-decoration: none;">é€€å‡ºç™»å½•</a></p>
        </div>

        <!-- åŸºç¡€æ•°æ®ç»´æŠ¤ -->
        <div class="grid-3">
            <div class="section">
                <h2>ğŸ¯ å‘½é€”ç»´æŠ¤</h2>
                <div class="form-group">
                    <input type="text" id="fate-name" placeholder="å‘½é€”åç§°">
                    <div class="form-row">
                        <button onclick="addFate()" class="btn-success">æ·»åŠ å‘½é€”</button>
                        <button onclick="showEditModal('fate')" class="btn-warning">ä¿®æ”¹å‘½é€”</button>
                    </div>
                    <input type="text" id="delete-fate-name" placeholder="è¦åˆ é™¤çš„å‘½é€”åç§°">
                    <button onclick="deleteFate()" class="btn-danger">åˆ é™¤å‘½é€”</button>
                </div>
                <div id="fate-status" class="status">å‡†å¤‡ç»´æŠ¤å‘½é€”æ•°æ®...</div>
            </div>

            <div class="section">
                <h2>âš¡ å±æ€§ç»´æŠ¤</h2>
                <div class="form-group">
                    <input type="text" id="attr-name" placeholder="å±æ€§åç§°">
                    <div class="form-row">
                        <button onclick="addAttribute()" class="btn-success">æ·»åŠ å±æ€§</button>
                        <button onclick="showEditModal('attribute')" class="btn-warning">ä¿®æ”¹å±æ€§</button>
                    </div>
                    <input type="text" id="delete-attr-name" placeholder="è¦åˆ é™¤çš„å±æ€§åç§°">
                    <button onclick="deleteAttribute()" class="btn-danger">åˆ é™¤å±æ€§</button>
                </div>
                <div id="attr-status" class="status">å‡†å¤‡ç»´æŠ¤å±æ€§æ•°æ®...</div>
            </div>

            <div class="section">
                <h2>ğŸ° é˜µè¥ç»´æŠ¤</h2>
                <div class="form-group">
                    <input type="text" id="camp-name" placeholder="é˜µè¥åç§°">
                    <div class="form-row">
                        <button onclick="addCamp()" class="btn-success">æ·»åŠ é˜µè¥</button>
                        <button onclick="showEditModal('camp')" class="btn-warning">ä¿®æ”¹é˜µè¥</button>
                    </div>
                    <input type="text" id="delete-camp-name" placeholder="è¦åˆ é™¤çš„é˜µè¥åç§°">
                    <button onclick="deleteCamp()" class="btn-danger">åˆ é™¤é˜µè¥</button>
                </div>
                <div id="camp-status" class="status">å‡†å¤‡ç»´æŠ¤é˜µè¥æ•°æ®...</div>
            </div>
        </div>

        <!-- æ ‡ç­¾ç»´æŠ¤ -->
        <div class="section">
            <h2>ğŸ·ï¸ æ ‡ç­¾ç»´æŠ¤</h2>
            <div class="form-row">
                <input type="text" id="tag-name" placeholder="æ ‡ç­¾åç§°">
                <button onclick="addTag()" class="btn-success">æ·»åŠ æ ‡ç­¾</button>
                <button onclick="showEditModal('tag')" class="btn-warning">ä¿®æ”¹æ ‡ç­¾</button>
                <input type="text" id="delete-tag-name" placeholder="è¦åˆ é™¤çš„æ ‡ç­¾åç§°">
                <button onclick="deleteTag()" class="btn-danger">åˆ é™¤æ ‡ç­¾</button>
            </div>
            <div id="tag-status" class="status">å‡†å¤‡ç»´æŠ¤æ ‡ç­¾æ•°æ®...</div>
        </div>

        <!-- è§’è‰²ç»´æŠ¤ -->
        <div class="section">
            <h2>ğŸ‘¤ è§’è‰²ç»´æŠ¤</h2>
            <div class="form-row">
                <input type="text" id="char-name" placeholder="è§’è‰²åç§°" required>
                <textarea id="char-desc" placeholder="è§’è‰²æè¿°"></textarea>
                <input type="text" id="char-skill" placeholder="æŠ€èƒ½æè¿°">
            </div>
            <div class="form-row">
                <select id="char-camp" required>
                    <option value="">é€‰æ‹©é˜µè¥</option>
                </select>
                <select id="char-attr" required>
                    <option value="">é€‰æ‹©å±æ€§</option>
                </select>
                <select id="char-fate" required>
                    <option value="">é€‰æ‹©å‘½é€”</option>
                </select>
            </div>
            <div class="form-row">
                <button onclick="addCharacter()" class="btn-success">æ·»åŠ è§’è‰²</button>
                <button onclick="showEditModal('character')" class="btn-warning">ä¿®æ”¹è§’è‰²</button>
                <input type="text" id="delete-char-name" placeholder="è¦åˆ é™¤çš„è§’è‰²åç§°">
                <button onclick="deleteCharacter()" class="btn-danger">åˆ é™¤è§’è‰²</button>
                <button onclick="loadDropdowns()" class="btn-info">åˆ·æ–°ä¸‹æ‹‰æ¡†</button>
            </div>
            <div id="char-status" class="status">å‡†å¤‡ç»´æŠ¤è§’è‰²æ•°æ®...</div>
        </div>

        <!-- BOSSç»´æŠ¤ -->
        <div class="section">
            <h2>ğŸ‘¹ BOSSç»´æŠ¤</h2>
            <div class="form-row">
                <input type="text" id="boss-name" placeholder="BOSSåç§°" required>
                <textarea id="boss-desc" placeholder="BOSSæè¿°"></textarea>
            </div>
            <div class="form-row">
                <select id="boss-camp" required>
                    <option value="">é€‰æ‹©é˜µè¥</option>
                </select>
                <select id="boss-weakness" required>
                    <option value="">é€‰æ‹©å¼±ç‚¹å±æ€§</option>
                </select>
            </div>
            <div class="form-row">
                <button onclick="addBoss()" class="btn-success">æ·»åŠ BOSS</button>
                <button onclick="showEditModal('boss')" class="btn-warning">ä¿®æ”¹BOSS</button>
                <input type="text" id="delete-boss-name" placeholder="è¦åˆ é™¤çš„BOSSåç§°">
                <button onclick="deleteBoss()" class="btn-danger">åˆ é™¤BOSS</button>
            </div>
            <div id="boss-status" class="status">å‡†å¤‡ç»´æŠ¤BOSSæ•°æ®...</div>
        </div>

        <!-- ç¯å¢ƒç»´æŠ¤ -->
        <div class="section">
            <h2>ğŸŒ ç¯å¢ƒç»´æŠ¤</h2>
            <div class="form-row">
                <input type="text" id="env-name" placeholder="ç¯å¢ƒåç§°" required>
                <textarea id="env-buff" placeholder="ç¯å¢ƒæ•ˆæœæè¿°"></textarea>
            </div>
            <div class="form-row">
                <button onclick="addEnvironment()" class="btn-success">æ·»åŠ ç¯å¢ƒ</button>
                <button onclick="showEditModal('environment')" class="btn-warning">ä¿®æ”¹ç¯å¢ƒ</button>
                <input type="text" id="delete-env-name" placeholder="è¦åˆ é™¤çš„ç¯å¢ƒåç§°">
                <button onclick="deleteEnvironment()" class="btn-danger">åˆ é™¤ç¯å¢ƒ</button>
            </div>
            <div id="env-status" class="status">å‡†å¤‡ç»´æŠ¤ç¯å¢ƒæ•°æ®...</div>
        </div>

        <!-- å…³è”å…³ç³»ç»´æŠ¤ -->
        <div class="grid-3">
            <div class="section">
                <h2>ğŸ”— è§’è‰²-æ ‡ç­¾å…³è”</h2>
                <div class="form-row">
                    <select id="rel-char" required>
                        <option value="">é€‰æ‹©è§’è‰²</option>
                    </select>
                    <select id="rel-char-tag" required>
                        <option value="">é€‰æ‹©æ ‡ç­¾</option>
                    </select>
                </div>
                <div class="form-row">
                    <button onclick="addCharacterTag()" class="btn-success">æ·»åŠ å…³è”</button>
                    <button onclick="deleteCharacterTag()" class="btn-danger">åˆ é™¤å…³è”</button>
                </div>
                <div id="char-tag-status" class="status">å‡†å¤‡ç»´æŠ¤è§’è‰²æ ‡ç­¾å…³è”...</div>
            </div>

            <div class="section">
                <h2>ğŸ”— ç¯å¢ƒ-æ ‡ç­¾å…³è”</h2>
                <div class="form-row">
                    <select id="rel-env" required>
                        <option value="">é€‰æ‹©ç¯å¢ƒ</option>
                    </select>
                    <select id="rel-env-tag" required>
                        <option value="">é€‰æ‹©æ ‡ç­¾</option>
                    </select>
                </div>
                <div class="form-row">
                    <button onclick="addEnvironmentTag()" class="btn-success">æ·»åŠ å…³è”</button>
                    <button onclick="deleteEnvironmentTag()" class="btn-danger">åˆ é™¤å…³è”</button>
                </div>
                <div id="env-tag-status" class="status">å‡†å¤‡ç»´æŠ¤ç¯å¢ƒæ ‡ç­¾å…³è”...</div>
            </div>

            <div class="section">
                <h2>ğŸ”— BOSS-æ ‡ç­¾å…³è”</h2>
                <div class="form-row">
                    <select id="rel-boss" required>
                        <option value="">é€‰æ‹©BOSS</option>
                    </select>
                    <select id="rel-boss-tag" required>
                        <option value="">é€‰æ‹©æ ‡ç­¾</option>
                    </select>
                </div>
                <div class="form-row">
                    <button onclick="addBossTag()" class="btn-success">æ·»åŠ å…³è”</button>
                    <button onclick="deleteBossTag()" class="btn-danger">åˆ é™¤å…³è”</button>
                </div>
                <div id="boss-tag-status" class="status">å‡†å¤‡ç»´æŠ¤BOSSæ ‡ç­¾å…³è”...</div>
            </div>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€ -->
        <div class="section">
            <h2>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h2>
            <div class="form-row">
                <button onclick="testConnection()" class="btn-info">ğŸ”— æµ‹è¯•è¿æ¥</button>
                <button onclick="showAllData()" class="btn-info">ğŸ“Š æ˜¾ç¤ºæ•°æ®</button>
                <button onclick="loadAllRelationData()" class="btn-info">ğŸ”„ åˆ·æ–°å…³è”æ•°æ®</button>
                <button onclick="clearLog()" class="btn-warning">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
            </div>
            <div id="system-status" class="status">ç³»ç»Ÿå¯åŠ¨ä¸­...</div>
        </div>
    </div>

    <!-- ä¿®æ”¹å¼¹çª— -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">ä¿®æ”¹æ•°æ®</h3>
            <div class="form-group">
                <input type="text" id="edit-old-name" placeholder="åŸåç§°" required>
                <input type="text" id="edit-new-name" placeholder="æ–°åç§°" required>
                <div class="form-row">
                    <button onclick="confirmEdit()" class="btn-success">ç¡®è®¤ä¿®æ”¹</button>
                    <button onclick="closeEditModal()" class="btn-danger">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentEditType = '';

        function log(msg, target = 'system-status', type = 'info') {
            const el = document.getElementById(target);
            const time = new Date().toLocaleTimeString();
            const className = `log-${type}`;
            el.innerHTML += `<div class="${className}">[${time}] ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
            console.log(`[${type}] ${msg}`);
        }

        function clearLog() {
            document.getElementById('system-status').innerHTML = '';
        }

        async function api(url, options = {}) {
            try {
                const res = await fetch(`http://localhost:5000${url}`, {
                    headers: { 'Content-Type': 'application/json' },
                    ...options
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
                return data;
            } catch (err) {
                throw err;
            }
        }

        function updateSelect(id, data, valueField, textField, placeholder) {
            const select = document.getElementById(id);
            select.innerHTML = `<option value="">${placeholder}</option>`;
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueField];
                option.textContent = item[textField];
                select.appendChild(option);
            });
        }

        async function loadDropdowns() {
            log('ğŸ”„ åŠ è½½ä¸‹æ‹‰æ¡†æ•°æ®...', 'system-status', 'info');
            try {
                const [camps, attrs, fates] = await Promise.all([
                    api('/api/camps'),
                    api('/api/attributes'),
                    api('/api/fates')
                ]);

                updateSelect('char-camp', camps, 'camp_id', 'camp_name', 'é€‰æ‹©é˜µè¥');
                updateSelect('boss-camp', camps, 'camp_id', 'camp_name', 'é€‰æ‹©é˜µè¥');
                updateSelect('char-attr', attrs, 'attribute_id', 'attribute_name', 'é€‰æ‹©å±æ€§');
                updateSelect('boss-weakness', attrs, 'attribute_id', 'attribute_name', 'é€‰æ‹©å¼±ç‚¹');
                updateSelect('char-fate', fates, 'fate_id', 'fate_name', 'é€‰æ‹©å‘½é€”');

                log(`âœ… ä¸‹æ‹‰æ¡†åŠ è½½å®Œæˆ: é˜µè¥${camps.length}, å±æ€§${attrs.length}, å‘½é€”${fates.length}`, 'system-status', 'success');
            } catch (err) {
                log(`âŒ ä¸‹æ‹‰æ¡†åŠ è½½å¤±è´¥: ${err.message}`, 'system-status', 'error');
            }
        }

        async function loadAllRelationData() {
            log('ğŸ”„ åŠ è½½å…³è”æ•°æ®...', 'system-status', 'info');
            try {
                const [chars, envs, bosses, tags] = await Promise.all([
                    api('/api/characters'),
                    api('/api/environments'),
                    api('/api/bosses'),
                    api('/api/tags')
                ]);

                updateSelect('rel-char', chars, 'character_id', 'name', 'é€‰æ‹©è§’è‰²');
                updateSelect('rel-env', envs, 'env_id', 'name', 'é€‰æ‹©ç¯å¢ƒ');
                updateSelect('rel-boss', bosses, 'boss_id', 'name', 'é€‰æ‹©BOSS');
                updateSelect('rel-char-tag', tags, 'tag_id', 'name', 'é€‰æ‹©æ ‡ç­¾');
                updateSelect('rel-env-tag', tags, 'tag_id', 'name', 'é€‰æ‹©æ ‡ç­¾');
                updateSelect('rel-boss-tag', tags, 'tag_id', 'name', 'é€‰æ‹©æ ‡ç­¾');

                log(`âœ… å…³è”æ•°æ®åŠ è½½å®Œæˆ: è§’è‰²${chars.length}, ç¯å¢ƒ${envs.length}, BOSS${bosses.length}, æ ‡ç­¾${tags.length}`, 'system-status', 'success');
            } catch (err) {
                log(`âŒ å…³è”æ•°æ®åŠ è½½å¤±è´¥: ${err.message}`, 'system-status', 'error');
            }
        }

        // åŸºç¡€æ•°æ®æ·»åŠ å‡½æ•°
        async function addFate() {
            const name = document.getElementById('fate-name').value.trim();
            if (!name) { log('âŒ è¯·è¾“å…¥å‘½é€”åç§°', 'fate-status', 'error'); return; }
            try {
                await api('/api/fates', { method: 'POST', body: JSON.stringify({ fate_name: name }) });
                log(`âœ… å‘½é€”æ·»åŠ æˆåŠŸ: ${name}`, 'fate-status', 'success');
                document.getElementById('fate-name').value = '';
                loadDropdowns();
            } catch (err) {
                log(`âŒ å‘½é€”æ·»åŠ å¤±è´¥: ${err.message}`, 'fate-status', 'error');
            }
        }

        async function addAttribute() {
            const name = document.getElementById('attr-name').value.trim();
            if (!name) { log('âŒ è¯·è¾“å…¥å±æ€§åç§°', 'attr-status', 'error'); return; }
            try {
                await api('/api/attributes', { method: 'POST', body: JSON.stringify({ attribute_name: name }) });
                log(`âœ… å±æ€§æ·»åŠ æˆåŠŸ: ${name}`, 'attr-status', 'success');
                document.getElementById('attr-name').value = '';
                loadDropdowns();
            } catch (err) {
                log(`âŒ å±æ€§æ·»åŠ å¤±è´¥: ${err.message}`, 'attr-status', 'error');
            }
        }

        async function addCamp() {
            const name = document.getElementById('camp-name').value.trim();
            if (!name) { log('âŒ è¯·è¾“å…¥é˜µè¥åç§°', 'camp-status', 'error'); return; }
            try {
                await api('/api/camps', { method: 'POST', body: JSON.stringify({ camp_name: name }) });
                log(`âœ… é˜µè¥æ·»åŠ æˆåŠŸ: ${name}`, 'camp-status', 'success');
                document.getElementById('camp-name').value = '';
                loadDropdowns();
            } catch (err) {
                log(`âŒ é˜µè¥æ·»åŠ å¤±è´¥: ${err.message}`, 'camp-status', 'error');
            }
        }

        async function addTag() {
            const name = document.getElementById('tag-name').value.trim();
            if (!name) { log('âŒ è¯·è¾“å…¥æ ‡ç­¾åç§°', 'tag-status', 'error'); return; }
            try {
                await api('/api/tags', { method: 'POST', body: JSON.stringify({ name }) });
                log(`âœ… æ ‡ç­¾æ·»åŠ æˆåŠŸ: ${name}`, 'tag-status', 'success');
                document.getElementById('tag-name').value = '';
                loadAllRelationData();
            } catch (err) {
                log(`âŒ æ ‡ç­¾æ·»åŠ å¤±è´¥: ${err.message}`, 'tag-status', 'error');
            }
        }

        // åˆ é™¤å‡½æ•°
        async function deleteFate() {
            const name = document.getElementById('delete-fate-name').value.trim();
            if (!name) { log('âŒ è¯·è¾“å…¥å‘½é€”åç§°', 'fate-status', 'error'); return; }
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å‘½é€”"${name}"å—ï¼Ÿ`)) return;
            try {
                await api(`/api/fates?name=${encodeURIComponent(name)}`, { method: 'DELETE' });
                log(`âœ… å‘½é€”åˆ é™¤æˆåŠŸ: ${name}`, 'fate-status', 'success');
                document.getElementById('delete-fate-name').value = '';
                loadDropdowns();
            } catch (err) {
                log(`âŒ å‘½é€”åˆ é™¤å¤±è´¥: ${err.message}`, 'fate-status', 'error');
            }
        }

        async function deleteAttribute() {
            const name = document.getElementById('delete-attr-name').value.trim();
            if (!name) { log('âŒ è¯·è¾“å…¥å±æ€§åç§°', 'attr-status', 'error'); return; }
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å±æ€§"${name}"å—ï¼Ÿ`)) return;
            try {
                await api(`/api/attributes?name=${encodeURIComponent(name)}`, { method: 'DELETE' });
                log(`âœ… å±æ€§åˆ é™¤æˆåŠŸ: ${name}`, 'attr-status', 'success');
                document.getElementById('delete-attr-name').value = '';
                loadDropdowns();
            } catch (err) {
                log(`âŒ å±æ€§åˆ é™¤å¤±è´¥: ${err.message}`, 'attr-status', 'error');
            }
        }

        async function deleteCamp() {
            const name = document.getElementById('delete-camp-name').value.trim();
            if (!name) { log('âŒ è¯·è¾“å…¥é˜µè¥åç§°', 'camp-status', 'error'); return; }
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é˜µè¥"${name}"å—ï¼Ÿ`)) return;
            try {
                await api(`/api/camps?name=${encodeURIComponent(name)}`, { method: 'DELETE' });
                log(`âœ… é˜µè¥åˆ é™¤æˆåŠŸ: ${name}`, 'camp-status', 'success');
                document.getElementById('delete-camp-name').value = '';
                loadDropdowns();
            } catch (err) {
                log(`âŒ é˜µè¥åˆ é™¤å¤±è´¥: ${err.message}`, 'camp-status', 'error');
            }
        }

        async function deleteTag() {
            const name = document.getElementById('delete-tag-name').value.trim();
            if (!name) { log('âŒ è¯·è¾“å…¥æ ‡ç­¾åç§°', 'tag-status', 'error'); return; }
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ ‡ç­¾"${name}"å—ï¼Ÿ`)) return;
            try {
                await api(`/api/tags?name=${encodeURIComponent(name)}`, { method: 'DELETE' });
                log(`âœ… æ ‡ç­¾åˆ é™¤æˆåŠŸ: ${name}`, 'tag-status', 'success');
                document.getElementById('delete-tag-name').value = '';
                loadAllRelationData();
            } catch (err) {
                log(`âŒ æ ‡ç­¾åˆ é™¤å¤±è´¥: ${err.message}`, 'tag-status', 'error');
            }
        }

        // è§’è‰²ç»´æŠ¤
        async function addCharacter() {
            const name = document.getElementById('char-name').value.trim();
            const description = document.getElementById('char-desc').value.trim();
            const skill = document.getElementById('char-skill').value.trim();
            const camp_id = document.getElementById('char-camp').value;
            const attribute_id = document.getElementById('char-attr').value;
            const fate_id = document.getElementById('char-fate').value;

            if (!name || !camp_id || !attribute_id || !fate_id) {
                log('âŒ è¯·å¡«å†™è§’è‰²åç§°å¹¶é€‰æ‹©æ‰€æœ‰é€‰é¡¹', 'char-status', 'error');
                return;
            }

            try {
                await api('/api/characters', {
                    method: 'POST',
                    body: JSON.stringify({ name, description, skill, camp_id, attribute_id, fate_id })
                });
                log(`âœ… è§’è‰²æ·»åŠ æˆåŠŸ: ${name}`, 'char-status', 'success');
                document.getElementById('char-name').value = '';
                document.getElementById('char-desc').value = '';
                document.getElementById('char-skill').value = '';
                loadAllRelationData();
            } catch (err) {
                log(`âŒ è§’è‰²æ·»åŠ å¤±è´¥: ${err.message}`, 'char-status', 'error');
            }
        }

        async function deleteCharacter() {
            const name = document.getElementById('delete-char-name').value.trim();
            if (!name) { log('âŒ è¯·è¾“å…¥è§’è‰²åç§°', 'char-status', 'error'); return; }
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è§’è‰²"${name}"å—ï¼Ÿ`)) return;
            try {
                await api(`/api/characters?name=${encodeURIComponent(name)}`, { method: 'DELETE' });
                log(`âœ… è§’è‰²åˆ é™¤æˆåŠŸ: ${name}`, 'char-status', 'success');
                document.getElementById('delete-char-name').value = '';
                loadAllRelationData();
            } catch (err) {
                log(`âŒ è§’è‰²åˆ é™¤å¤±è´¥: ${err.message}`, 'char-status', 'error');
            }
        }

        // BOSSç»´æŠ¤
        async function addBoss() {
            const name = document.getElementById('boss-name').value.trim();
            const description = document.getElementById('boss-desc').value.trim();
            const camp_id = document.getElementById('boss-camp').value;
            const weakness_id = document.getElementById('boss-weakness').value;

            if (!name || !camp_id || !weakness_id) {
                log('âŒ è¯·å¡«å†™BOSSåç§°å¹¶é€‰æ‹©é€‰é¡¹', 'boss-status', 'error');
                return;
            }

            try {
                await api('/api/bosses', {
                    method: 'POST',
                    body: JSON.stringify({ name, description, camp_id, weakness_id })
                });
                log(`âœ… BOSSæ·»åŠ æˆåŠŸ: ${name}`, 'boss-status', 'success');
                document.getElementById('boss-name').value = '';
                document.getElementById('boss-desc').value = '';
                loadAllRelationData();
            } catch (err) {
                log(`âŒ BOSSæ·»åŠ å¤±è´¥: ${err.message}`, 'boss-status', 'error');
            }
        }

        async function deleteBoss() {
            const name = document.getElementById('delete-boss-name').value.trim();
            if (!name) { log('âŒ è¯·è¾“å…¥BOSSåç§°', 'boss-status', 'error'); return; }
            if (!confirm(`ç¡®å®šè¦åˆ é™¤BOSS"${name}"å—ï¼Ÿ`)) return;
            try {
                await api(`/api/bosses?name=${encodeURIComponent(name)}`, { method: 'DELETE' });
                log(`âœ… BOSSåˆ é™¤æˆåŠŸ: ${name}`, 'boss-status', 'success');
                document.getElementById('delete-boss-name').value = '';
                loadAllRelationData();
            } catch (err) {
                log(`âŒ BOSSåˆ é™¤å¤±è´¥: ${err.message}`, 'boss-status', 'error');
            }
        }

        // ç¯å¢ƒç»´æŠ¤
        async function addEnvironment() {
            const name = document.getElementById('env-name').value.trim();
            const buff = document.getElementById('env-buff').value.trim();

            if (!name) { log('âŒ è¯·è¾“å…¥ç¯å¢ƒåç§°', 'env-status', 'error'); return; }

            try {
                await api('/api/environments', {
                    method: 'POST',
                    body: JSON.stringify({ name, buff })
                });
                log(`âœ… ç¯å¢ƒæ·»åŠ æˆåŠŸ: ${name}`, 'env-status', 'success');
                document.getElementById('env-name').value = '';
                document.getElementById('env-buff').value = '';
                loadAllRelationData();
            } catch (err) {
                log(`âŒ ç¯å¢ƒæ·»åŠ å¤±è´¥: ${err.message}`, 'env-status', 'error');
            }
        }

        async function deleteEnvironment() {
            const name = document.getElementById('delete-env-name').value.trim();
            if (!name) { log('âŒ è¯·è¾“å…¥ç¯å¢ƒåç§°', 'env-status', 'error'); return; }
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç¯å¢ƒ"${name}"å—ï¼Ÿ`)) return;
            try {
                await api(`/api/environments?name=${encodeURIComponent(name)}`, { method: 'DELETE' });
                log(`âœ… ç¯å¢ƒåˆ é™¤æˆåŠŸ: ${name}`, 'env-status', 'success');
                document.getElementById('delete-env-name').value = '';
                loadAllRelationData();
            } catch (err) {
                log(`âŒ ç¯å¢ƒåˆ é™¤å¤±è´¥: ${err.message}`, 'env-status', 'error');
            }
        }

        // å…³è”å…³ç³»ç»´æŠ¤
        async function addCharacterTag() {
            const character_id = document.getElementById('rel-char').value;
            const tag_id = document.getElementById('rel-char-tag').value;

            if (!character_id || !tag_id) {
                log('âŒ è¯·é€‰æ‹©è§’è‰²å’Œæ ‡ç­¾', 'char-tag-status', 'error');
                return;
            }

            try {
                await api('/api/character_tags', {
                    method: 'POST',
                    body: JSON.stringify({ character_id, tag_id })
                });
                log(`âœ… è§’è‰²æ ‡ç­¾å…³è”æ·»åŠ æˆåŠŸ`, 'char-tag-status', 'success');
            } catch (err) {
                log(`âŒ è§’è‰²æ ‡ç­¾å…³è”æ·»åŠ å¤±è´¥: ${err.message}`, 'char-tag-status', 'error');
            }
        }

        async function deleteCharacterTag() {
            const character_id = document.getElementById('rel-char').value;
            const tag_id = document.getElementById('rel-char-tag').value;

            if (!character_id || !tag_id) {
                log('âŒ è¯·é€‰æ‹©è§’è‰²å’Œæ ‡ç­¾', 'char-tag-status', 'error');
                return;
            }

            try {
                await api('/api/character_tags', {
                    method: 'DELETE',
                    body: JSON.stringify({ character_id, tag_id })
                });
                log(`âœ… è§’è‰²æ ‡ç­¾å…³è”åˆ é™¤æˆåŠŸ`, 'char-tag-status', 'success');
            } catch (err) {
                log(`âŒ è§’è‰²æ ‡ç­¾å…³è”åˆ é™¤å¤±è´¥: ${err.message}`, 'char-tag-status', 'error');
            }
        }

        async function addEnvironmentTag() {
            const env_id = document.getElementById('rel-env').value;
            const tag_id = document.getElementById('rel-env-tag').value;

            if (!env_id || !tag_id) {
                log('âŒ è¯·é€‰æ‹©ç¯å¢ƒå’Œæ ‡ç­¾', 'env-tag-status', 'error');
                return;
            }

            try {
                await api('/api/environment_tags', {
                    method: 'POST',
                    body: JSON.stringify({ env_id, tag_id })
                });
                log(`âœ… ç¯å¢ƒæ ‡ç­¾å…³è”æ·»åŠ æˆåŠŸ`, 'env-tag-status', 'success');
            } catch (err) {
                log(`âŒ ç¯å¢ƒæ ‡ç­¾å…³è”æ·»åŠ å¤±è´¥: ${err.message}`, 'env-tag-status', 'error');
            }
        }

        async function deleteEnvironmentTag() {
            const env_id = document.getElementById('rel-env').value;
            const tag_id = document.getElementById('rel-env-tag').value;

            if (!env_id || !tag_id) {
                log('âŒ è¯·é€‰æ‹©ç¯å¢ƒå’Œæ ‡ç­¾', 'env-tag-status', 'error');
                return;
            }

            try {
                await api('/api/environment_tags', {
                    method: 'DELETE',
                    body: JSON.stringify({ env_id, tag_id })
                });
                log(`âœ… ç¯å¢ƒæ ‡ç­¾å…³è”åˆ é™¤æˆåŠŸ`, 'env-tag-status', 'success');
            } catch (err) {
                log(`âŒ ç¯å¢ƒæ ‡ç­¾å…³è”åˆ é™¤å¤±è´¥: ${err.message}`, 'env-tag-status', 'error');
            }
        }

        async function addBossTag() {
            const boss_id = document.getElementById('rel-boss').value;
            const tag_id = document.getElementById('rel-boss-tag').value;

            if (!boss_id || !tag_id) {
                log('âŒ è¯·é€‰æ‹©BOSSå’Œæ ‡ç­¾', 'boss-tag-status', 'error');
                return;
            }

            try {
                await api('/api/boss_tags', {
                    method: 'POST',
                    body: JSON.stringify({ boss_id, tag_id })
                });
                log(`âœ… BOSSæ ‡ç­¾å…³è”æ·»åŠ æˆåŠŸ`, 'boss-tag-status', 'success');
            } catch (err) {
                log(`âŒ BOSSæ ‡ç­¾å…³è”æ·»åŠ å¤±è´¥: ${err.message}`, 'boss-tag-status', 'error');
            }
        }

        async function deleteBossTag() {
            const boss_id = document.getElementById('rel-boss').value;
            const tag_id = document.getElementById('rel-boss-tag').value;

            if (!boss_id || !tag_id) {
                log('âŒ è¯·é€‰æ‹©BOSSå’Œæ ‡ç­¾', 'boss-tag-status', 'error');
                return;
            }

            try {
                await api('/api/boss_tags', {
                    method: 'DELETE',
                    body: JSON.stringify({ boss_id, tag_id })
                });
                log(`âœ… BOSSæ ‡ç­¾å…³è”åˆ é™¤æˆåŠŸ`, 'boss-tag-status', 'success');
            } catch (err) {
                log(`âŒ BOSSæ ‡ç­¾å…³è”åˆ é™¤å¤±è´¥: ${err.message}`, 'boss-tag-status', 'error');
            }
        }

        // ä¿®æ”¹åŠŸèƒ½çš„å¼¹çª—
        function showEditModal(type) {
            currentEditType = type;
            const modal = document.getElementById('edit-modal');
            const title = document.getElementById('modal-title');
            
            const typeNames = {
                'fate': 'å‘½é€”',
                'attribute': 'å±æ€§', 
                'camp': 'é˜µè¥',
                'tag': 'æ ‡ç­¾',
                'character': 'è§’è‰²',
                'boss': 'BOSS',
                'environment': 'ç¯å¢ƒ'
            };
            
            title.textContent = `ä¿®æ”¹${typeNames[type]}`;
            document.getElementById('edit-old-name').value = '';
            document.getElementById('edit-new-name').value = '';
            modal.style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        async function confirmEdit() {
            const oldName = document.getElementById('edit-old-name').value.trim();
            const newName = document.getElementById('edit-new-name').value.trim();
            
            if (!oldName || !newName) {
                alert('è¯·å¡«å†™åŸåç§°å’Œæ–°åç§°');
                return;
            }

            const endpoints = {
                'fate': '/api/fates',
                'attribute': '/api/attributes',
                'camp': '/api/camps',
                'tag': '/api/tags',
                'character': '/api/characters',
                'boss': '/api/bosses',
                'environment': '/api/environments'
            };

            const bodyFields = {
                'fate': { old_name: oldName, new_name: newName },
                'attribute': { old_name: oldName, new_name: newName },
                'camp': { old_name: oldName, new_name: newName },
                'tag': { old_name: oldName, new_name: newName },
                'character': { old_name: oldName, new_name: newName },
                'boss': { old_name: oldName, new_name: newName },
                'environment': { old_name: oldName, new_name: newName }
            };

            try {
                await api(endpoints[currentEditType], {
                    method: 'PUT',
                    body: JSON.stringify(bodyFields[currentEditType])
                });
                
                const statusTargets = {
                    'fate': 'fate-status',
                    'attribute': 'attr-status',
                    'camp': 'camp-status',
                    'tag': 'tag-status',
                    'character': 'char-status',
                    'boss': 'boss-status',
                    'environment': 'env-status'
                };
                
                log(`âœ… ${currentEditType}ä¿®æ”¹æˆåŠŸ: ${oldName} -> ${newName}`, statusTargets[currentEditType], 'success');
                closeEditModal();
                
                if (['fate', 'attribute', 'camp'].includes(currentEditType)) {
                    loadDropdowns();
                } else {
                    loadAllRelationData();
                }
            } catch (err) {
                log(`âŒ ä¿®æ”¹å¤±è´¥: ${err.message}`, 'system-status', 'error');
            }
        }

        // ç³»ç»ŸåŠŸèƒ½
        async function testConnection() {
            log('ğŸ”— æµ‹è¯•è¿æ¥...', 'system-status', 'info');
            try {
                const fates = await api('/api/fates');
                log(`âœ… è¿æ¥æ­£å¸¸ï¼Œå‘½é€”: ${fates.length}æ¡`, 'system-status', 'success');
            } catch (err) {
                log(`âŒ è¿æ¥å¤±è´¥: ${err.message}`, 'system-status', 'error');
            }
        }

        async function showAllData() {
            try {
                const [camps, attrs, fates, chars, bosses, envs, tags] = await Promise.all([
                    api('/api/camps'),
                    api('/api/attributes'),
                    api('/api/fates'),
                    api('/api/characters'),
                    api('/api/bosses'),
                    api('/api/environments'),
                    api('/api/tags')
                ]);
                log('ğŸ“Š æ•°æ®åº“ç»Ÿè®¡:');
                log(`   é˜µè¥: ${camps.length}ä¸ª - ${camps.map(c => c.camp_name).join(', ')}`);
                log(`   å±æ€§: ${attrs.length}ä¸ª - ${attrs.map(a => a.attribute_name).join(', ')}`);
                log(`   å‘½é€”: ${fates.length}ä¸ª - ${fates.map(f => f.fate_name).join(', ')}`);
                log(`   æ ‡ç­¾: ${tags.length}ä¸ª - ${tags.map(t => t.name).join(', ')}`);
                log(`   è§’è‰²: ${chars.length}ä¸ª`);
                log(`   BOSS: ${bosses.length}ä¸ª`);
                log(`   ç¯å¢ƒ: ${envs.length}ä¸ª`);
            } catch (err) {
                log(`âŒ æ•°æ®è·å–å¤±è´¥: ${err.message}`, 'system-status', 'error');
            }
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ æ•°æ®ç»´æŠ¤ç³»ç»Ÿå¯åŠ¨...', 'system-status', 'info');
            
            // è®¾ç½®ç”¨æˆ·å
            const userData = JSON.parse(localStorage.getItem('user') || '{}');
            if (userData.user) {
                document.getElementById('username').textContent = userData.user.username;
            }
            
            // å»¶è¿ŸåŠ è½½æ•°æ®
            setTimeout(() => {
                testConnection();
                loadDropdowns();
                loadAllRelationData();
            }, 1000);
        });

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­å¼¹çª—
        window.onclick = function(event) {
            const modal = document.getElementById('edit-modal');
            if (event.target == modal) {
                closeEditModal();
            }
        }
    </script>
</body>
</html> 